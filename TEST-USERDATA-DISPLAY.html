<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test UserData Display - Shinhan Finance</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #00468F;
      border-bottom: 3px solid #2BB673;
      padding-bottom: 10px;
    }
    .section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .status {
      display: inline-block;
      padding: 5px 15px;
      border-radius: 20px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .status.success { background: #d1fae5; color: #065f46; }
    .status.error { background: #fee2e2; color: #991b1b; }
    .status.warning { background: #fef3c7; color: #92400e; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }
    th {
      background: #f9fafb;
      font-weight: 600;
      color: #00468F;
    }
    .value {
      font-weight: 600;
      color: #1f2937;
    }
    .default {
      color: #dc2626;
      font-style: italic;
    }
    .loaded {
      color: #059669;
    }
    button {
      background: #00468F;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #003a78;
    }
    .code-block {
      background: #1f2937;
      color: #f3f4f6;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-family: 'Courier New', monospace;
      font-size: 14px;
    }
    .nav-links {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    .nav-links a {
      background: #2BB673;
      color: white;
      padding: 10px 20px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 600;
    }
    .nav-links a:hover {
      background: #059669;
    }
  </style>
</head>
<body>
  <h1>üß™ Test UserData Display - Ki·ªÉm tra d·ªØ li·ªáu hi·ªÉn th·ªã</h1>

  <!-- Status -->
  <div class="section">
    <h2>üìä Tr·∫°ng th√°i localStorage</h2>
    <div id="storageStatus"></div>
  </div>

  <!-- UserData -->
  <div class="section">
    <h2>üë§ D·ªØ li·ªáu ng∆∞·ªùi d√πng</h2>
    <table id="userDataTable">
      <thead>
        <tr>
          <th>Tr∆∞·ªùng</th>
          <th>Gi√° tr·ªã</th>
          <th>Tr·∫°ng th√°i</th>
        </tr>
      </thead>
      <tbody id="userDataBody">
        <tr><td colspan="3">ƒêang t·∫£i...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Test Results -->
  <div class="section">
    <h2>‚úÖ K·∫øt qu·∫£ ki·ªÉm tra</h2>
    <div id="testResults"></div>
  </div>

  <!-- Raw Data -->
  <div class="section">
    <h2>üîç Raw Data (JSON)</h2>
    <button onclick="toggleRawData()">Toggle Raw Data</button>
    <pre id="rawData" class="code-block" style="display: none;"></pre>
  </div>

  <!-- Navigation -->
  <div class="section">
    <h2>üîó Test Navigation</h2>
    <div class="nav-links">
      <a href="pages/vi/step6.html">Step 6 - H·ª£p ƒê·ªìng</a>
      <a href="pages/vi/step7.html">Step 7 - ƒêi·ªÅu Ki·ªán</a>
      <a href="pages/vi/step8.html">Step 8 - Ph√™ Duy·ªát</a>
    </div>
  </div>

  <!-- Actions -->
  <div class="section">
    <h2>‚öôÔ∏è Actions</h2>
    <button onclick="reloadData()">üîÑ Reload Data</button>
    <button onclick="createMockData()">üìù Create Mock Data</button>
    <button onclick="clearData()">üóëÔ∏è Clear Data</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <script>
    let userData = null;

    // Load and decrypt userData
    function loadUserData() {
      try {
        const raw = localStorage.getItem('userData');
        
        if (!raw) {
          document.getElementById('storageStatus').innerHTML = 
            '<span class="status error">‚ùå Kh√¥ng t√¨m th·∫•y userData trong localStorage</span>';
          return null;
        }

        document.getElementById('storageStatus').innerHTML = 
          '<span class="status success">‚úÖ T√¨m th·∫•y userData trong localStorage</span>';

        // Try to decrypt
        let data;
        try {
          const bytes = CryptoJS.AES.decrypt(raw, 'shinhan-secret-key');
          const decrypted = bytes.toString(CryptoJS.enc.Utf8);
          if (decrypted) {
            data = JSON.parse(decrypted);
            document.getElementById('storageStatus').innerHTML += 
              '<br><span class="status success">üîê D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c m√£ h√≥a (Decrypted)</span>';
          } else {
            data = JSON.parse(raw);
            document.getElementById('storageStatus').innerHTML += 
              '<br><span class="status warning">‚ö†Ô∏è D·ªØ li·ªáu kh√¥ng m√£ h√≥a (Plain JSON)</span>';
          }
        } catch {
          data = JSON.parse(raw);
          document.getElementById('storageStatus').innerHTML += 
            '<br><span class="status warning">‚ö†Ô∏è D·ªØ li·ªáu kh√¥ng m√£ h√≥a (Plain JSON)</span>';
        }

        return data;
      } catch (err) {
        console.error('Error loading userData:', err);
        document.getElementById('storageStatus').innerHTML = 
          '<span class="status error">‚ùå L·ªói khi load userData: ' + err.message + '</span>';
        return null;
      }
    }

    // Display userData in table
    function displayUserData(data) {
      const tbody = document.getElementById('userDataBody');
      
      if (!data) {
        tbody.innerHTML = '<tr><td colspan="3" class="default">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
        return;
      }

      const fields = [
        { key: 'fullName', label: 'H·ªç v√† t√™n', required: true },
        { key: 'phone', label: 'S·ªë ƒëi·ªán tho·∫°i', required: true },
        { key: 'email', label: 'Email', required: true },
        { key: 'cccd', label: 'S·ªë CCCD', required: true },
        { key: 'loanAmount', label: 'S·ªë ti·ªÅn vay', required: true, format: 'currency' },
        { key: 'loanTerm', label: 'K·ª≥ h·∫°n vay', required: true, suffix: ' th√°ng' },
        { key: 'interestRate', label: 'L√£i su·∫•t', required: false, suffix: '%/nƒÉm' },
        { key: 'monthlyPayment', label: 'Tr·∫£ h√†ng th√°ng', required: false, format: 'currency' },
        { key: 'loanPurpose', label: 'M·ª•c ƒë√≠ch vay', required: false },
        { key: 'accountNumber', label: 'S·ªë t√†i kho·∫£n', required: false },
        { key: 'bankName', label: 'Ng√¢n h√†ng', required: false },
        { key: 'accountName', label: 'T√™n t√†i kho·∫£n', required: false },
        { key: 'disbursementDate', label: 'Ng√†y gi·∫£i ng√¢n', required: false },
        { key: 'loanCode', label: 'M√£ kho·∫£n vay', required: false },
        { key: 'currentStep', label: 'B∆∞·ªõc hi·ªán t·∫°i', required: false }
      ];

      let html = '';
      let errors = [];

      fields.forEach(field => {
        const value = data[field.key];
        let displayValue = '';
        let statusClass = '';
        let statusText = '';

        if (value === undefined || value === null || value === '' || value === 'N/A' || value === 0) {
          if (field.required) {
            statusClass = 'default';
            statusText = '‚ùå Thi·∫øu (Required)';
            displayValue = '<em>Ch∆∞a c√≥ d·ªØ li·ªáu</em>';
            errors.push(`${field.label} b·ªã thi·∫øu`);
          } else {
            statusClass = 'warning';
            statusText = '‚ö†Ô∏è Ch∆∞a c√≥';
            displayValue = '<em>Ch∆∞a ƒëi·ªÅn</em>';
          }
        } else {
          statusClass = 'loaded';
          statusText = '‚úÖ ƒê√£ load';
          
          if (field.format === 'currency') {
            const num = parseFloat(value);
            displayValue = !isNaN(num) ? num.toLocaleString('en-US') + ' VND' : value;
          } else if (field.suffix) {
            displayValue = value + field.suffix;
          } else {
            displayValue = value;
          }
        }

        html += `
          <tr>
            <td><strong>${field.label}</strong> ${field.required ? '<span style="color: #dc2626;">*</span>' : ''}</td>
            <td class="value ${statusClass}">${displayValue}</td>
            <td>${statusText}</td>
          </tr>
        `;
      });

      tbody.innerHTML = html;

      // Display test results
      const resultsDiv = document.getElementById('testResults');
      if (errors.length > 0) {
        resultsDiv.innerHTML = `
          <div class="status error">‚ùå Ph√°t hi·ªán ${errors.length} l·ªói:</div>
          <ul>
            ${errors.map(err => `<li>${err}</li>`).join('')}
          </ul>
          <p><strong>Khuy·∫øn ngh·ªã:</strong> Vui l√≤ng ho√†n t·∫•t form ƒëƒÉng k√Ω tr∆∞·ªõc khi ti·∫øp t·ª•c.</p>
        `;
      } else {
        resultsDiv.innerHTML = `
          <div class="status success">‚úÖ T·∫•t c·∫£ d·ªØ li·ªáu b·∫Øt bu·ªôc ƒë√£ c√≥</div>
          <p><strong>K·∫øt lu·∫≠n:</strong> UserData h·ª£p l·ªá, c√≥ th·ªÉ hi·ªÉn th·ªã tr√™n step6, step7, step8.</p>
        `;
      }

      // Calculate required amount (10%)
      if (data.loanAmount) {
        const required = parseFloat(data.loanAmount) * 0.1;
        resultsDiv.innerHTML += `
          <div style="margin-top: 15px; padding: 10px; background: #fef3c7; border-left: 4px solid #FFB703; border-radius: 4px;">
            <strong>üí∞ S·ªë d∆∞ c·∫ßn ch·ª©ng minh (10%):</strong> 
            <span style="font-size: 1.2rem; color: #92400e;">${required.toLocaleString('en-US')} VND</span>
          </div>
        `;
      }
    }

    // Display raw JSON
    function displayRawData(data) {
      document.getElementById('rawData').textContent = JSON.stringify(data, null, 2);
    }

    // Toggle raw data
    function toggleRawData() {
      const elem = document.getElementById('rawData');
      elem.style.display = elem.style.display === 'none' ? 'block' : 'none';
    }

    // Reload data
    function reloadData() {
      userData = loadUserData();
      if (userData) {
        displayUserData(userData);
        displayRawData(userData);
      }
    }

    // Create mock data for testing
    function createMockData() {
      const mockData = {
        fullName: "Nguy·ªÖn VƒÉn Test",
        phone: "0901234567",
        email: "test@example.com",
        cccd: "001234567890",
        loanAmount: 30000000,
        loanTerm: 12,
        interestRate: 12.5,
        monthlyPayment: 2678000,
        loanPurpose: "Ti√™u d√πng",
        accountNumber: "1234567890",
        bankName: "Vietcombank",
        accountName: "Nguyen Van Test",
        disbursementDate: "2025-01-15",
        loanCode: "SHB123456",
        currentStep: 8,
        isRegistered: true,
        idIssueDate: "2020-01-15",
        idIssuePlace: "TP. H·ªì Ch√≠ Minh"
      };

      // Encrypt and save
      const encrypted = CryptoJS.AES.encrypt(
        JSON.stringify(mockData), 
        'shinhan-secret-key'
      ).toString();
      
      localStorage.setItem('userData', encrypted);
      
      alert('‚úÖ ƒê√£ t·∫°o mock data th√†nh c√¥ng!\nVui l√≤ng reload ƒë·ªÉ xem.');
      reloadData();
    }

    // Clear data
    function clearData() {
      if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a userData?')) {
        localStorage.removeItem('userData');
        alert('‚úÖ ƒê√£ x√≥a userData');
        reloadData();
      }
    }

    // Init
    window.onload = function() {
      userData = loadUserData();
      if (userData) {
        displayUserData(userData);
        displayRawData(userData);
      } else {
        document.getElementById('userDataBody').innerHTML = 
          '<tr><td colspan="3" class="default">‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu. Click "Create Mock Data" ƒë·ªÉ test.</td></tr>';
      }
    };
  </script>
</head>
<body>
  <h1>üß™ Test UserData Display</h1>
  
  <div class="section" style="background: #dbeafe; border-left: 4px solid #00468F;">
    <h3 style="margin: 0 0 10px 0; color: #00468F;">üìã M·ª•c ƒë√≠ch test</h3>
    <p style="margin: 0;">
      File n√†y gi√∫p ki·ªÉm tra xem userData t·ª´ localStorage c√≥ ƒë∆∞·ª£c load v√† hi·ªÉn th·ªã ƒë√∫ng 
      tr√™n c√°c trang step6, step7, step8 hay kh√¥ng. T·∫•t c·∫£ c√°c tr∆∞·ªùng <span style="color: #dc2626;">*</span> 
      (required) ph·∫£i c√≥ gi√° tr·ªã.
    </p>
  </div>

  <!-- Placeholder divs will be filled by JavaScript -->
  <div id="storageStatus"></div>
  <div id="userDataTable"></div>
  <div id="testResults"></div>
  <div id="rawData"></div>

</body>
</html>
